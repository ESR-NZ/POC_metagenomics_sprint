---
title: "POC metagenomics dashboard"
output: 
  flexdashboard::flex_dashboard:
    source_code: embed
    orientation: rows
    vertical_layout: scroll
runtime: shiny
---

```{r global, include = FALSE}
# Load libraries
library(flexdashboard)
library(here)
library(ggplot2)
library(plotly)
library(dplyr)
library(DT)
library(fontawesome)

# capture arg for results DIR coming from bash script
results_dir <- commandArgs(trailingOnly=T)[1]

# Setup path to directory of recentrifuge html files
# shiny::addResourcePath(prefix = "path_to_results", directoryPath = here::here("./Results/"))
shiny::addResourcePath(prefix = "path_to_results", directoryPath = here::here(results_dir))

# Read all kraken csv files
recentrifuge_df_list <- lapply(Sys.glob(paste0("../", results_dir, "*_output.krk.stat.csv")), read.csv)

# Merge all kraken csv files together into one dataframe
recentrifuge_csv <- bind_cols(recentrifuge_df_list)

# Rename variable column
colnames(recentrifuge_csv)[colnames(recentrifuge_csv) == "X...1"] <- "var"

# Drop redundant columns
recentrifuge_csv <- recentrifuge_csv %>% select(-contains("X"))

# Read AMR output file
# amr_resgenes <- read.delim("../data/test_dna.got", header=TRUE, allowEscapes=FALSE, sep="\t",  quote="", na.strings="", comment.char="")

# Create a list of samples based on the files present in the kraken output directory
isolates <- list.files(path = paste0("../", results_dir))

# Get only the sample names from the file list (everything before "_")
isolates <- sub("_.*", "", isolates)

# Get the unique samples names
isolates <- unique(isolates)

htmltools::tagList(fontawesome::fa_html_dependency())
```

Inputs {.sidebar}
-----------------------------------------------------------------------

```{r}
# User input to choose sample of interest to view ----
selectizeInput("isolate",
               h4("Select or search for an isolate:"),
               choices = isolates,
               options = list(maxItems = 1))
```

Row
-------------------------------------

### Sequences read
    
```{r}
# Load in the current isolate the user has chosen to view so it can be used for "recentrifuge_html_path"
selected_isolate <- reactive(input$isolate)

seqs_read <- reactive(recentrifuge_csv %>%
  select(contains(selected_isolate()), var) %>%
  filter(var == "Seqs. read") %>%
  pull(var = 1))

renderValueBox({
  
  # Print a message if no isolate is chosen
  validate(need(input$isolate, "NULL"))
  
  valueBox(value = seqs_read(),
           caption = "Sequences read",
           icon = "fa-bars",
           color = "primary")
})

```

### Sequences classified
    
```{r}
classified <- reactive(recentrifuge_csv %>%
  select(contains(selected_isolate()), var) %>%
  filter(var == "Seqs. class.") %>%
  pull(var = 1))

renderValueBox({
  
  # Print a message if no isolate is chosen
  validate(need(input$isolate, "NULL"))
  
  valueBox(value = classified(),
           caption = "Sequences classified",
          #  icon = "fa-check",
           icon = "fa-bacteria",
           color = "primary")
})

```

### Mean read length
    
```{r}
unclassified <- reactive(recentrifuge_csv %>%
  select(contains(selected_isolate()), var) %>%
  filter(var == "Length mean") %>%
  pull(var = 1))

renderValueBox({
  
  # Print a message if no isolate is chosen
  validate(need(input$isolate, "NULL"))
  
  valueBox(value = unclassified(),
           caption = "Mean read length",
           icon = "fa-dna",
           color = "primary")
})

```

### Top classification
    
```{r}
tophit <- reactive(recentrifuge_csv %>%
  select(contains(selected_isolate()), var) %>%
  filter(var == "Top hit") %>%
  pull(var = 1))

renderValueBox({
  
  # Print a message if no isolate is chosen
  validate(need(input$isolate, "NULL"))
  
  valueBox(value = tophit(),
           caption = "Top classification",
           #  icon = "fa-bacterium",
           color = "green")
})

```

Column {data-height=800}
-------------------------------------
    
### Species composition
    
```{r}
# Embed the appropriate recentrifuge html file in the dashboard

# Load in the current isolate the user has chosen to view so it can be used for "recentrifuge_html_path"
selected_isolate <- reactive(input$isolate)
recentrifuge_html_path <- reactive(paste0("path_to_results/", selected_isolate(), "_output.krk.html"))

# Plot
renderUI({
  
  # Print a message if no isolate is chosen
  validate(need(input$isolate, "Please choose an isolate from the drop down box to create a plot"))
  
  # Embed html
  tags$iframe(src = recentrifuge_html_path(), height = "100%", width = "100%")
  
})
```

Row
-------------------------------------

### Read length distribution
  
```{r, fig.width=5, fig.height=5, align="center"}
# Load in the current isolate the user has chosen to view so it can be used for "recentrifuge_html_path"
selected_isolate <- reactive(input$isolate)
read_dist_path <- reactive(paste0("path_to_results/", selected_isolate(), "_all_reads.fq_read_length_distrabution_plot.png"))

renderUI({
  
  # Print a message if no isolate is chosen
  validate(need(input$isolate, "Please choose an isolate from the drop down box to create a plot"))
  
  # Embed png
  tags$iframe(src = read_dist_path(), width = "100%", height = "100%")
})
```

```{r, echo = FALSE}
session$onSessionEnded(stopApp)
```
